<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Protéger les entrées</title>
<link rel="stylesheet" href="../_local/codemirror.css">
<script src="../_local/codemirror_pour_php.js"></script>

<link rel="stylesheet" href="../_core/def.css">
<script>
	if (top.FP) {
		document.addEventListener('DOMContentLoaded', top.FP.initPage, false);
	} else {
		location.replace('../index.html?x=' + encodeURI(location.href));
	}
</script>
</head>
<body>
	<div id="MENU-top"></div>
	<nav id="MENU-tuto"></nav>

	<div id="PAGE-tuto">
		<header></header>

		<!-- 
		<p class="fp-remarque">
			Rappel : si vous travaillez sur votre ordinateur personnel vous devez
			<a onclick="top.FP.Voir.showPLUS('exemple/initbase.php')">créer
				la base de données de test</a> pour que les exemples soient réalisables.
		</p>
-->
		<p class="fp-rouge" style="border: 1px solid; padding: 4px">
			Il est indispensable de protéger toutes les chaînes de caractères
			provenant d'une saisie utilisateur avec <a
				href="https://www.php.net/manual/fr/mysqli.real-escape-string.php" target="_blank">mysqli_real_escape_string()</a>
			dans toutes les requêtes SQL.
		</p>

		<p class="fp-puce">
			Dans le script <span class="fp-code">auteurs_liste.php</span> on
			utilise une chaîne saisie par l'utilisateur pour composer une partie de
			la requête SQL de sélection.
		</p>

		<pre data-code="PHP">
$nom = mysqli_real_escape_string($bd,$_SESSION['recherche']['nom']);
		
// pour notamment empécher un utilisateur de lister  
// toute la table si il saisit un pourcent 
// dans le critère de recherche
$nom = addcslashes($nom, '%_');

if ($_SESSION['recherche']['pos'] == 1) {
	$where = "WHERE auNom LIKE '$nom%'";
	...
} elseif ($_SESSION['recherche']['pos'] == 2) {
	$where = "WHERE auNom LIKE '%$nom%'";
	...
} else {
	$where = "WHERE auNom LIKE '%$nom'";
	...
}
...

//-- Requête ----------------------------------------
$sql = "SELECT auID, auNom, auPrenom, auPays
		FROM auteurs
		$where
		ORDER BY auNom, auPrenom";
</pre>

		<p>
			C'est quelque chose que l'on réalise très souvent, soit pour composer
			la clause <span class="fp-code">WHERE</span> d'une requête <span
				class="fp-code">SELECT</span>, soit dans les requêtes <span
				class="fp-code">INSERT</span> ou <span class="fp-code">UPDATE</span>.
		</p>

		<p class="fp-puce">
			Avant insertion dans une requête SQL, il est primordial de <strong>protéger les
				chaînes saisies par l'utilisateur</strong> avec la fonction <a
				href="https://www.php.net/manual/fr/mysqli.real-escape-string.php" target="_blank">mysqli_real_escape_string()</a>,
			car ces chaînes pourraient contenir des caractères spéciaux qu'on ne peut pas insérés tels quels dans une requête SQL :
			guillemets simples ou doubles, \0, \n, ctrl-Z, etc.
		<p>
		<p> La fonction 
			<a
				href="https://www.php.net/manual/fr/mysqli.real-escape-string.php" target="_blank">mysqli_real_escape_string()</a>
			<b>protège tous ces caractères spéciaux en les échappant avec un \</b>.
		</p>
		

		<p>Dans l'exemple suivant, la chaîne saisie n'est pas protégée.
			Pour voir le résultat, saisissez un nom avec un ou des guillemets
			simples (par exemple O'Reilly ou Le Floc'h ou N'Go).</p>



		<form action="" method="post" class="TEST-form">
			<a class="TEST-lien"
				onclick="top.FP.Voir.showPLUS('exemple/bib_fonctions_12.html')"
				title="Afficher la bibliothéque de fonctions"></a> <a
				class="TEST-lien-bd" title="Afficher le schéma de la base"
				onclick="top.FP.Voir.showPLUS('exemple/php_tuto_bd.html')"></a>
			<div class="TEST-titre">
				<strong>Exemple</strong> : pas de protection des chaînes
			</div>
			<textarea name="txtCode" class="TEST-textarea">
&lt;?php
ob_start();

require('bib_params.php');
require('bib_fonctions.php');

//---------------------------------------------------
// Phase affichage du formulaire de saisie
if (!isset($_POST['btnOk'])) {
	htmlDebut('Rechercher auteurs', 'bd.css');
	echo '&lt;form method="POST" ',
			'action="', $_SERVER['PHP_SELF'], '"&gt;',
		'Nom &lt;input type="text" name="txtNom"&gt;',
		'&lt;input type="submit" name="btnOk" value="Ok"&gt;',
		'&lt;/form&gt;';
	
	htmlFin();
	exit();		// ==&gt; FIN si affichage formulaire
}

//---------------------------------------------------
// Phase traitement de la saisie
htmlDebut('Liste auteurs', 'bd.css');

$bd = bdConnecter();

$nom = trim($_POST['txtNom']);

//-- Requête --
$sql = "SELECT auNom, auPrenom, auPays
		FROM auteurs
		WHERE auNom LIKE '%$nom%'
		ORDER BY auNom, auPrenom";

$r = mysqli_query($bd, $sql) or bdErreur($bd, $sql);

//-- Liste --
htmlTable(array('Nom', 'Prénom', 'Pays'), 'tab-bd');

while ($enr = mysqli_fetch_assoc($r)) {
	htmlProteger($enr);
	htmlLigne($enr);
}

// Libération de la mémoire associée au résultat de la requête
mysqli_free_result($r);

//-- Déconnexion ------------------------------------
mysqli_close($bd);

echo '&lt;/table&gt;';

htmlFin();
?&gt;</textarea>
		</form>

		<p class="fp-puce fp-inter2">
			En "protégeant" la chaîne saisie avec <a
				href="https://www.php.net/manual/fr/mysqli.real-escape-string.php" target="_blank">mysqli_real_escape_string()</a>,
			l'erreur dans la requête <span class="fp-code">SELECT</span> disparait.
		</p>

		<form action="" method="post" class="TEST-form">
			<a class="TEST-lien"
				onclick="top.FP.Voir.showPLUS('exemple/bib_fonctions_12.html')"
				title="Afficher la bibliothéque de fonctions"></a> <a
				class="TEST-lien-bd" title="Afficher le schéma de la base"
				onclick="top.FP.Voir.showPLUS('exemple/php_tuto_bd.html')"></a>
			<div class="TEST-titre">
				<strong>Exemple</strong> : protection des chaînes
			</div>
			<textarea name="txtCode" class="TEST-textarea">
&lt;?php
ob_start();

require('bib_params.php');
require('bib_fonctions.php');

//---------------------------------------------------
// Phase affichage du formulaire de saisie
if (!isset($_POST['btnOk'])) {
	htmlDebut('Rechercher auteurs', 'bd.css');
	echo '&lt;form method="POST" ',
			'action="', $_SERVER['PHP_SELF'], '"&gt;',
		'Nom &lt;input type="text" name="txtNom"&gt;',
		'&lt;input type="submit" name="btnOk" value="Ok"&gt;',
		'&lt;/form&gt;';
	
	htmlFin();
	exit();		// ==&gt; FIN si affichage formulaire
}

//---------------------------------------------------
// Phase traitement de la saisie
htmlDebut('Liste auteurs', 'bd.css');

$bd = bdConnecter();

$nom = trim($_POST['txtNom']);

echo '&lt;hr&gt; DEBUG, avant $nom = ', $nom;

$nom = mysqli_real_escape_string($bd, $nom);

echo '&lt;hr&gt; DEBUG, après $nom = ', $nom;

//-- Requête --
$sql = "SELECT auNom, auPrenom, auPays
		FROM auteurs
		WHERE auNom LIKE '%$nom%'
		ORDER BY auNom, auPrenom";

echo '&lt;hr&gt; DEBUG, $sql =&lt;br&gt;&lt;pre&gt;', $sql;
echo '&lt;/pre&gt;&lt;hr&gt;';

$r = mysqli_query($bd, $sql) or bdErreur($bd, $sql);

//-- Liste --
htmlTable(array('Nom', 'Prénom', 'Pays'), 'tab-bd');

while ($enr = mysqli_fetch_assoc($r)) {
	htmlProteger($enr);
	htmlLigne($enr);
}

// Libération de la mémoire associée au résultat de la requête
mysqli_free_result($r);

//-- Déconnexion ------------------------------------
mysqli_close($bd);

echo '&lt;/table&gt;';

htmlFin();
?&gt;</textarea>
		</form>
		
		<p class="fp-puce">
			La fonction  <a
				href="https://www.php.net/manual/fr/mysqli.real-escape-string.php" target="_blank">mysqli_real_escape_string()</a>
			permet également de <b>se protéger contre les attaques de type <a href="https://www.owasp.org/index.php/SQL_Injection" target="_blank">injections SQL</a></b>. 
		</p>
		
		<p class="fp-puce">
			Notez, dans la page <span class="fp-code">auteurs_liste.php</span>, l'utilisation de la fonction <a
				href="https://www.php.net/manual/fr/function.addcslashes.php" target="_blank">addcslashes()</a> qui
			permet d'échapper des caractères supplémentaires, ici le pourcent (<span class="fp-code">%</span>) et l'underscore
			(<span class="fp-code">_</span>), afin de leur oter leur sens spécial avant insertion dans la requête SQL.
			
		</p>

		<p class="fp-rouge" style="border: 1px solid; padding: 4px">
			Il est indispensable de protéger toutes les chaînes de caractères
			provenant d'une saisie utilisateur avec <a
				href="https://www.php.net/manual/fr/mysqli.real-escape-string.php" target="_blank">mysqli_real_escape_string()</a>
			dans toutes les requêtes SQL.
		</p>
	</div>
	<footer></footer>
</body>
</html>