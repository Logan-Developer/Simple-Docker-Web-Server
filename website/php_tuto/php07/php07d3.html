<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Mise à jour - Liste</title>
<link rel="stylesheet" href="../_local/codemirror.css">
<script src="../_local/codemirror_pour_php.js"></script>

<link rel="stylesheet" href="../_core/def.css">
<script>
	if (top.FP) {
		document.addEventListener('DOMContentLoaded', top.FP.initPage, false);
	} else {
		location.replace('../index.html?x=' + encodeURI(location.href));
	}
</script>
</head>
<body>
	<div id="MENU-top"></div>
	<nav id="MENU-tuto"></nav>

	<div id="PAGE-tuto">
		<header></header>

		<!-- 
		<p class="fp-remarque">
			Rappel : si vous travaillez sur votre ordinateur personnel vous devez
			<a onclick="top.FP.Voir.showPLUS('exemple/initbase.php')">créer
				la base de données de test</a> pour que les exemples soient réalisables.
		</p>
-->
		<figure>
			<img src="../phpimg/auteurs_liste.png" width="400" height="272">
			<figcaption>page liste des auteurs</figcaption>
		</figure>

		<p class="fp-puce fp-bottom0">
			Le script <span class="fp-code">auteurs_liste.php</span> affiche la
			liste des auteurs sélectionnés d'après les critères saisis dans la
			page <span class="fp-code">auteurs_cherche.php</span>. C'est la
			clause <span class="fp-code">WHERE</span> du <span class="fp-code">SELECT</span>
			sur la table <span class="fp-code">auteurs</span> qui fait cette
			sélection.
		</p>
		<ul class="fp-ul-puce">
			<li>Si on arrive de la page <span class="fp-code">auteurs_cherche.php</span>,
				la clause <span class="fp-code">WHERE</span> est faite avec les
				éléments du formulaire.
			</li>
			<li>Si on revient de la page <span class="fp-code">auteurs_maj.php</span>,
				la clause <span class="fp-code">WHERE</span> est faite avec les données
				stockées dans la variable de session <span class="fp-code">$_SESSION['recherche']</span>.
			</li>
			<li>
				Pour être valide, le critère de recherche (ie le nom saisi dans l' <span class="fp-code">input</span>
			de type <span class="fp-code">text</span> de la page <span class="fp-code">auteurs_cherche.php</span>) ne doit pas être vide. Si on arrive sur cette page
				avec un critère de recherche vide, un message signale le problème à l'utilisateur. Cela permet
				de ne jamais afficher tout le contenu de la table auteurs.
			</li>
		</ul>

		<figure class="fp-f-right" style="margin-left: 10px">
			<img src="../phpimg/auteurs_orga_2.png" width="272" height="280">
			<figcaption>liaisons page liste</figcaption>
		</figure>

		<p class="fp-puce fp-bottom0">L'utilisateur a le choix entre
			plusieurs actions.</p>
		<ul class="fp-ul-puce">
			<li>Il peut choisir dans la liste un auteur à modifier ou à supprimer en
				cliquant sur son nom. L'url du lien pointe sur la page <span
				class="fp-code">auteurs_maj.php</span> et contient l'id de l'auteur
				à modifier (crypté bien sûr).
			</li>
			<li>Il peut cliquer sur le bouton "Recherche" pour revenir à la
				page de recherche <span class="fp-code">auteurs_cherche.php</span>
			</li>
			<li>Il peut cliquer sur le bouton "Ajouter" pour passer
				directement à la phase de création d'un auteur (<span
				class="fp-code">auteurs_maj.php</span>).
			</li>
		</ul>



		<p>
			Le code du script <span class="fp-code">auteurs_liste.php</span> est
			un peu plus complexe que celui de <span class="fp-code">auteurs_cherche.php</span>,
			surtout à cause de la gestion à faire des éléments saisis. 
			On commence par traiter les paramètres reçus dans le tableau <span class="fp-code">$_POST</span>
			avant de générer le code HTML de la page.
			La partie
			sélection et affichage des résultats a déjà été vue de nombreuses
			fois dans les pages précédentes. Quelques commentaires après le code.
		</p>

		<form action="" method="post" class="TEST-form">
			<a class="TEST-lien"
				onclick="top.FP.Voir.showPLUS('exemple/bib_fonctions_12.html')"
				title="Afficher la bibliothéque de fonctions"></a> <a
				class="TEST-lien-bd" title="Afficher le schéma de la base"
				onclick="top.FP.Voir.showPLUS('exemple/php_tuto_bd.html')"></a>
			<div class="NO-TEST-titre">Script auteurs_liste.php</div>
			<textarea name="txtCode" class="TEST-textarea" data-readonly="true">
&lt;?php
ob_start();
session_start();

require('bib_params.php');
require('bib_fonctions.php');

$_SESSION['idAuteur'] = 0;

/*----------------------------------------------------------
-- Début du traitement des paramètres reçus 
-- (contenus dans $_POST)
----------------------------------------------------------*/
if (isset($_POST['btnChercher'])) {
	// Si on vient de la page de recherche, on récupère
	// les critères de recherche, et on les stocke dans
	// la variable de session pour pouvoir les réutiliser.
	
	// contrôle que les clés attendues dans $_POST 
	// sont bien présentes
	if (!isset($_POST['radNom']) || !isset($_POST['txtNom'])) {
		header('Location: auteurs_cherche.php');
		exit();	//==&gt; FIN piratage ?
	}
	if (!estEntier($_POST['radNom'])) {
		header('Location: auteurs_cherche.php');
		exit();	//==&gt; FIN piratage ?
	}

	$position = (int) $_POST['radNom'];
	if (!estEntre($position, 1, 3)) {
		header('Location: auteurs_cherche.php');
		exit();	//==&gt; FIN piratage ?
	}

	$nom = trim($_POST['txtNom']);
	
	if ($nom != '') {
		// Mise à jour de la variable de session
		$_SESSION['recherche']['pos'] = $position;
		$_SESSION['recherche']['nom'] = $nom;
	}
	
} elseif (! isset($_POST['btnListe'])) {
	header('Location: auteurs_cherche.php');
	exit();	//==&gt; FIN piratage ?

}
/*-----------------------------------------------------------
-- Fin du traitement des paramètres reçus 
-----------------------------------------------------------*/

/*-----------------------------------------------------------
-- Envoi du code HTML de la page
-----------------------------------------------------------*/
htmlDebut('Liste auteurs', 'bd.css');

if (count($_SESSION['recherche']) == 2){
	$bd = bdConnecter();
	$nom = mysqli_real_escape_string($bd, 
	                     $_SESSION['recherche']['nom']);
		
	// pour notamment empécher un utilisateur de lister  
	// toute la table si il saisit un pourcent 
	// dans le critère de recherche
	$nom = addcslashes($nom, '%_');
	
	$message = 'Recherche des auteurs dont le nom ';
	
	if ($_SESSION['recherche']['pos'] == 1) {
		$where = "WHERE auNom LIKE '$nom%'";
		$message .= 'commence par "';
	} elseif ($_SESSION['recherche']['pos'] == 2) {
		$where = "WHERE auNom LIKE '%$nom%'";
		$message .= 'contient "';
	} else {
		$where = "WHERE auNom LIKE '%$nom'";
		$message .= 'finit par "';
	}
	$message .= htmlentities($_SESSION['recherche']['nom'], 
	                         ENT_COMPAT, 'ISO-8859-1').'".';
	echo '&lt;p class="pagination"&gt;', $message, '&lt;/p&gt;';
	
	//-- Requête ----------------------------------------
	$sql = "SELECT auID, auNom, auPrenom, auPays
			FROM auteurs
			$where
			ORDER BY auNom, auPrenom";

	$r = mysqli_query($bd, $sql) or bdErreur($bd, $sql);

	//-- Traitement -------------------------------------
	if (mysqli_num_rows($r) == 0){
		echo '&lt;p class="pagination"&gt;La liste est vide&lt;/p&gt;';
	}
	else{
		htmlTable(array('Nom', 'Prénom', 'Pays'), 'tab-bd');

		while ($enr = mysqli_fetch_assoc($r)) {
			htmlProteger($enr);

			$id = crypterURl($enr['auID']);
			$enr['auNom'] = '&lt;a href="auteurs_maj.php?x='
			                    .$id.'"&gt;'
								.$enr['auNom'].'&lt;/a&gt;';
			unset($enr['auID']);

			htmlLigne($enr);
		}

		echo '&lt;/table&gt;';
	}

	// Libération de la mémoire associée au 
	// résultat de la requête
	mysqli_free_result($r);
	
	//-- Déconnexion --------------------------------
	mysqli_close($bd);

}

//-- Boutons ----------------------------------------
echo '&lt;form method="POST" class="maj" ',
		 	'action="auteurs_cherche.php"&gt;',
	    count($_SESSION['recherche']) == 0 ? 
		'&lt;p class="pagination"&gt; Veuillez saisir un critère de recherche non vide&lt;/p&gt;': '',
		'&lt;p class="pagination"&gt;',
		'&lt;input type="submit" value="Ajouter" ',
			'name="btnNouveau" formaction="auteurs_maj.php"&gt;',
		'&lt;input type="submit" value="Recherche" ',
			'name="btnChercher"&gt;',
		'&lt;/p&gt;',
	'&lt;/form&gt;';

htmlFin();
?&gt;</textarea>
		</form>

		<p class="fp-t-center">
			<a onclick="top.FP.Voir.testCode(-1, '../test/auteurs_cherche.php')">Exécuter
				auteurs_cherche.php puis auteurs_liste.php</a>
		</p>

		<p class="fp-puce fp-bottom0">Il y a dans ce script 3 nouveautés :</p>
		<ul class="fp-ul-puce">
			<li>l'utilisation de l'opérateur <span class="fp-code">LIKE</span>
				dans une clause <span class="fp-code">WHERE</span>,
			</li>
			<li>une fonction de cryptage (et son pendant pour décrypter)
				dans la bibliothéque <span class="fp-code">bib_fonctions.php</span>,
			</li>
			<li>la protection des chaînes envoyées dans une requête SQL avec
				la fonction <a
				href="https://www.php.net/manual/fr/mysqli.real-escape-string.php" target="_blank">mysqli_real_escape_string()</a>
				(cf. chapitre suivant).
			</li>
		</ul>

		<p class="fp-puce fp-bottom0">
			L'opérateur SQL <span class="fp-code">LIKE</span> permet d'effectuer
			des sélections sur une partie seulement d'un champ alphanumérique. Il
			permet de définir des modèles de sélection plutôt que des des
			égalités strictes de chaînes de caractères. La définition de ces
			modèles se fait avec deux "jokers" :
		</p>
		<ul class="fp-ul-puce">
			<li>_ (underscore) remplace un et un seul caractère,</li>
			<li>% (pourcentage) remplace 0, un ou plusieurs caractères.</li>
		</ul>

		<p class="fp-puce fp-bottom0">Exemples :</p>
		<ul class="fp-ul-puce">
			<li><span class="fp-code">abc%</span> représente une chaîne
				commençant par abc ("abcdefgh", "abc efg", "abcd", "abc").</li>
			<li><span class="fp-code">%abc%</span> représente une chaîne
				contenant abc ("xyzabcdef", "xyzabc", "abcdef", "12 abc def").</li>
			<li><span class="fp-code">%abc</span> représente une chaîne se
				terminant par abc ("xyzabc", "abc", "123 abc", "abc").</li>
			<li><span class="fp-code">abc_</span> représente une chaîne
				commençant par abc et se terminant par n'importe quel autre
				caractère ("abcd", "abc ", "abc1"). La chaîne aura obligatoirement 4
				caractères.</li>
			<li><span class="fp-code">a_b_c</span> représente une chaîne
				commençant par a, suivi de n'importe quel autre caractère, puis de
				b, suivi de n'importe quel autre caractère, puis de c ("a1b c",
				"axbyc"). La chaîne aura obligatoirement 5 caractères.</li>

		</ul>

		<p class="fp-puce">
			Pour sélectionner un auteur à modifier, l'utilisateur clique sur un
			lien (le nom de l'auteur). Ce lien est composé avec un paramètre
			crypté (l'ID de l'auteur). Le cryptage est fait avec la fonction <span
				class="fp-code">crypterURL()</span> écrite sur les principes vues
			dans "Web et PHP", "Les liens". Cette fonction est placée dans notre
			bibliothéque de fonctions <span class="fp-code">bib_fonctions.php</span>.
		</p>

		<pre data-code="PHP">
/**
 * Crypte une valeur pour la passer dans une URL.
 *
 * @param mixed		$val	La valeur à crypter
 * @return string	La valeur cryptée et encodée url
 */
function crypterURL($val) {
	$ivlen = openssl_cipher_iv_length($cipher='AES-128-CBC');
	$sha2len=32;
	if (! isset ($_SESSION['cle_crytage'])){
		$_SESSION['cle_crytage'] = base64_encode(
		                   openssl_random_pseudo_bytes($ivlen));
		$_SESSION['cle_hachage'] = base64_encode(
		                   openssl_random_pseudo_bytes($sha2len));
	}
	
	// -- génération du vecteur d'initialisation
	$iv = openssl_random_pseudo_bytes($ivlen);
	// -- cryptage de $val
	$x = openssl_encrypt($val, $cipher, 
						 base64_decode($_SESSION['cle_crytage']), 
	                     OPENSSL_RAW_DATA, $iv);
	// -- calcul de la signature de la valeur cryptée
	$hmac = hash_hmac('sha256', $x, 
	                 base64_decode($_SESSION['cle_hachage']), true);
	
	$x = substr($hmac, 0, $sha2len/2)
	     .$iv.$x.substr($hmac, $sha2len/2);
	$x = base64_encode($x);
	return urlencode($x);
}</pre>
		
		<p>
			On a bien sûr aussi écrit la fonction <span class="fp-code">decrypterURL()</span>.
		</p>
		<pre data-code="PHP">
**
 * Décrypte une valeur cryptée avec la fonction crypterURL
 *
 * @param string	$x	La valeur à décrypter
 * @return mixed	La valeur décryptée ou FALSE si erreur
 */
function decrypterURL($x) {
	$ivlen = openssl_cipher_iv_length($cipher='AES-128-CBC');
	$x = base64_decode($x);
	$sha2len=32;
	$hmac = substr($x, 0, $sha2len/2).substr($x, -$sha2len/2);
	$iv = substr($x, $sha2len/2, $ivlen);
	$x = substr($x, $sha2len/2 + $ivlen, -$sha2len/2);
	// calcul de  la signature de la chaine cryptée reçue
	$hmacCalc = hash_hmac('sha256', $x, 
	                 base64_decode($_SESSION['cle_hachage']), true);
	if (! hash_equals($hmac, $hmacCalc)){
		return FALSE;
	}
	return openssl_decrypt($x, $cipher, 
	                       base64_decode($_SESSION['cle_crytage']), 
	                       OPENSSL_RAW_DATA, $iv);
}</pre>
		<p>
			Notez, dans la fonction <span class="fp-code">crypterURL()</span>, 
			la condition  <br><span class="fp-code">if (! isset ($_SESSION['cle_crytage']))</span><br>
			Son utilisation permet 
			de générer une paire de clés différente pour chaque utilisateur.
		</p>
	</div>
	<footer></footer>
</body>
</html>