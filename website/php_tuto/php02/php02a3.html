<!DOCTYPE html>
<html>
<head>
<title>Les dates</title>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<link rel="stylesheet" href="../_local/codemirror.css">
<script src="../_local/codemirror_pour_php.js"></script>

<link rel="stylesheet" href="../_core/def.css">
<script>
	if (top.FP) {
		document.addEventListener('DOMContentLoaded', top.FP.initPage, false);
	} else {
		location.replace('../index.html?x=' + encodeURI(location.href));
	}
</script>

</head>
<body>
	<div id="MENU-top"></div>
	<nav id="MENU-tuto"></nav>

	<div id="PAGE-tuto">
		<header></header>

		<ul id="MENU-page"></ul>

		<p class="fp-puce">
			La fonction <a
				href="https://www.php.net/manual/fr/function.microtime.php" target="_blank">microtime()</a>
			renvoie le nombre de secondes et de microsecondes écoulées depuis le
			1/1/1970. 
		</p>

		<p class="fp-bottom0 fp-puce">Suivant la valeur du paramètre booléen <span class="fp-code">get_as_float</span>, la fonction renvoie 
		un nombre décimal ou une chaîne de
			caractères composée de 2 sous-chaînes :</p>
		<ul class="fp-ul-puce">
			<li>le nombre de microsecondes</li>
			<li>nombre de secondes.</li>
		</ul>
		<form action="" method="post" class="TEST-form">
			<a class="TEST-lien"
				onclick="top.FP.Voir.showPLUS('exemple/bib_fonctions_03.html')"
				title="Afficher la bibliothéque de fonctions"></a>
			<div class="TEST-titre">
				<strong>Exemple</strong> : microsecondes
			</div>
			<textarea name="txtCode" class="TEST-textarea">&lt;?php
require('bib_fonctions.php');

htmlDebut('Microsecondes');

htmlInfo('La chaîne microtime');
// par défaut microtime() renvoie une chaine
echo microtime();

htmlInfo('Le nombre décimal microtime (version 1)');
// le paramètre 'get_as_float' est défini à TRUE
echo microtime(TRUE);

htmlFin();
?&gt;</textarea>
		</form>

<p>
On a ici l'impression que 
<a href="https://www.php.net/manual/fr/function.microtime.php" target="_blank">microtime()</a>
"fonctionne moins bien" quand on lui transmet <span class="fp-code">TRUE</span> pour qu'elle 
renvoie un nombre flottant car la précision des nombres décimaux serait insuffisante pour représenter un timestamp
avec une précision de 1µs. Mais c'est en réalité un peu plus compliqué...
</p>
<p class="fp-inter2">
			Pour récupérer un nombre décimal à partir de la 'chaîne microtime', nous pouvons utiliser les fonctions <a
				href="https://www.php.net/manual/fr/function.explode.php" target="_blank">explode()</a>
			et <a
				href="https://www.php.net/manual/fr/function.substr.php" target="_blank">substr()</a>
			comme dans l'exemple suivant.
		</p>

		<form action="" method="post" class="TEST-form">
			<a class="TEST-lien"
				onclick="top.FP.Voir.showPLUS('exemple/bib_fonctions_03.html')"
				title="Afficher la bibliothéque de fonctions"></a>
			<div class="TEST-titre">
				<strong>Exemple</strong> : microsecondes
			</div>
			<textarea name="txtCode" class="TEST-textarea">&lt;?php
require('bib_fonctions.php');

htmlDebut('Microsecondes');

$micro = microtime();

htmlInfo('La chaîne microtime');
echo $micro;

$t = explode(' ', $micro);

htmlInfo('Nombre de microsecondes');
echo substr($t[0], 2);

htmlInfo('Nombre de secondes');
echo $t[1];

htmlInfo('Le nombre décimal microtime (version 2)'); 
$nch = $t[1].substr($t[0], 1);
$n = (float)$nch;
echo $nch, '&lt;br&gt;', $n, '&lt;br&gt;'; 
printf("%.6f", $n);

htmlFin();
?&gt;</textarea>
		</form>


<p class="fp-bottom0">
	Explications : 
</p>
<ul class="fp-ul-puce">
<li>
quand <span class="fp-code">$n</span> est un nombre décimal, l'instruction <span class="fp-code">echo $n;</span> affiche 
au maximum 14 digits. C'est l'option de configuration 
<a href="https://www.php.net/manual/fr/ini.core.php#ini.precision" target="_blank">precision</a> 
fixée dans le fichier php.ini qui détermine le nombre de digits significatifs à afficher des nombres décimaux.
</li>
<li>
La fonction <a href="https://www.php.net/manual/fr/function.printf.php" target="_blank">printf()</a> permet ici 
d'afficher <span class="fp-code">$n</span> avec 6 digits après la virgule. Cet affichage "fonctionne" toujours car le type 
<span class="fp-code">float</span> en PHP permet de représenter un timestamp avec une précision de 1us.
</li>
<li>
Les nombres flottants ont une précision limitée. Pour représenter les nombres flottants, PHP utilise le format IEEE 754, 
ce qui donne une erreur maximale relative de l'ordre de 2^-52 = 2.22e-16 (la mantisse est codée sur 52 bits)<br>
Actuellement le timestamp est à peu près égal à 1570000000 secondes.<br>
Or 1570000000*2.22e-16 &ap; 3.5e-7s, ce qui prouve que le type float permet de coder le timestamp
avec une précision de 1us.
</li>
</ul>

<p>
	Conclusion : on peut utiliser la fonction 
	<a href="https://www.php.net/manual/fr/function.microtime.php" target="_blank">microtime()</a> en lui
	transmettant <span class="fp-code">TRUE</span> sans perte de précision, mais il faut prendre des précautions
	quand on affiche le résultat.
</p>
		


		<p>Le comptage du temps en microsecondes peut être utilisé par
			exemple pour mesurer les temps d'exécution d'un script ou de ses
			parties ou comme base pour la génération de nombre aléatoire.</p>
		<p>Nous allons construire un chronomètre qui permettra de mesurer
			les temps d'exécution de parties de script.</p>
		<form action="" method="post" class="TEST-form">
			<a class="TEST-lien"
				onclick="top.FP.Voir.showPLUS('exemple/bib_fonctions_03.html')"
				title="Afficher la bibliothéque de fonctions"></a>
			<div class="TEST-titre">
				<strong>Exemple</strong> : chronométre
			</div>
			<textarea name="txtCode" class="TEST-textarea">&lt;?php
require('bib_fonctions.php');

htmlDebut('Chronométre');

function chronometrer($txt = '', $precis = 5) {
    static $debut, $texte, $precision;
    
    // Debut du chronométrage
    if ($txt != '') {
        $texte = $txt;
        $precision = $precis;
        $debut = microtime();
        return;		// Fin du début
    }
    
    // Arrêt du chronométrage
    $fin = microtime();
	$t = explode(' ', $debut);
    $debut = $t[1].substr($t[0], 1);
	$t = explode(' ', $fin);
    $fin = $t[1].substr($t[0], 1);
    
    echo '&lt;hr&gt;Temps (', $texte, ') : ',
           round(bcsub($fin, $debut, 6), $precision),
           '&lt;hr&gt;';
}

// Démarre le chronomètre
chronometrer('boucle 100000 itérations');
for ($i = 0, $tmp = 0; $i &lt; 100000; $i++) {
	$tmp += $i;	// pour avoir quelque chose à faire
}
chronometrer();	// Arrête le chrono

// Démarre le chronomètre
chronometrer('boucle 10000 itérations', 10);
for ($i = 0, $tmp = 0; $i &lt; 10000; $i++) {
	$tmp += $i;	// pour avoir quelque chose à faire
}
chronometrer();	// Arrête le chrono

htmlFin();
?&gt;</textarea>
		</form>

		<p>
			C'est la fonction <span class="fp-code">chronometrer</span> qui fait tout le
			travail.
		</p>
		<pre data-code="PHP">
function chronometrer($txt = '', $precis = 5) {
    static $debut, $texte, $precision;
    
    // Debut du chronométrage
    if ($txt != '') {
        $texte = $txt;
        $precision = $precis;
        $debut = microtime();
        return;		// Fin du début
    }
    
    // Arrêt du chronométrage
    $fin = microtime();
	$t = explode(' ', $debut);
    $debut = $t[1].substr($t[0], 1);
	$t = explode(' ', $fin);
    $fin = $t[1].substr($t[0], 1);
    
    echo '&lt;hr&gt;Temps (', $texte, ') : ',
           round(bcsub($fin, $debut, 6), $precision),
           '&lt;hr&gt;';
}</pre>

		<p>
			Si le paramètre <span class="fp-code">$txt</span> contient quelque
			chose, le chronomètre est initialisé.
		</p>
		<p>
			Si le paramètre <span class="fp-code">$txt</span> est vide, nous
			considérons que le chronométre est arrêté. Nous récupérons la valeur
			du moment, transformons le moment du début et le moment de fin en
			chaines numériques, puis affichons le temps d'exécution en soustrayant les deux
			valeurs numériques et en les arrondissant à la précision voulue.
		</p>
		<p class="fp-bottom0">	
			Notez :
		</p>
		<ul class="fp-ul-puce">
		<li>
			l'utilisation de variables <b>statiques</b>. Une variable statique a une portée locale uniquement, 
			mais elle conserve sa valeur lorsque la fonction se termine. Lorsqu'on appelle la fonction
			<span class="fp-code">chronometrer()</span> pour la deuxième fois, les variables statiques 
			possèdent les valeurs qu'elles avaient à la fin de la première exécution de la fonction.
		</li>
		<li>
			l'utilisation de la fonction
			<a href="https://www.php.net/manual/fr/function.bcsub.php" target="_blank">bcsub()</a>
			qui permet de soustraire un nombre de grande taille à un autre. 
		</li>
		</ul>
		<p class="fp-remarque">
			L'utilisation de 
			<a href="https://www.php.net/manual/fr/function.bcsub.php" target="_blank">bcsub()</a>
			n'est ici pas nécessaire, car comme déjà expliqué, la précision des nombres flottants utilisés par PHP est suffisante
			pour mémoriser le nombre de secondes et de microsecondes écoulés depuis le 1/1/1970.
			Nous avons utiliser
			<a href="https://www.php.net/manual/fr/function.bcsub.php" target="_blank">bcsub()</a>
			juste pour vous indiquer que PHP dispose 
			de fonctions qui permettent la manipulation de nombres de grande taille.
		</p>
		<p class="fp-remarque">
			Ici, on a le fait le choix d'implémenter la fonction <span class="fp-code">chronometrer()</span>
			comme si le type <span class="fp-code">float</span> ne permettait pas
			de représenter un timestamp avec une précision satisfaisante.<br>
			On peut bien entendu simplifier le code de la fonction <span class="fp-code">chronometrer()</span> 
			en transmettant le paramètre <span class="fp-code">TRUE</span> à la fonction
			<a href="https://www.php.net/manual/fr/function.microtime.php" target="_blank">microtime()</a>.
		</p>
	</div>
	<footer></footer>
</body>
</html>
