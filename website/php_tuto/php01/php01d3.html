<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>Les instructions de contrôle</title>
<link rel="stylesheet" href="../_local/codemirror.css">
<script src="../_local/codemirror_pour_php.js"></script>

<link rel="stylesheet" href="../_core/def.css">
<script>
	if (top.FP) {
		document.addEventListener('DOMContentLoaded', top.FP.initPage, false);
	} else {
		location.replace('../index.html?x=' + encodeURI(location.href));
	}
</script>

</head>
<body>
	<div id="MENU-top"></div>
	<nav id="MENU-tuto"></nav>

	<div id="PAGE-tuto">
		<header></header>

		<ul id="MENU-page"></ul>
		<h3>Fin de script : exit</h3>
		<section>

			<p class="fp-puce">
				<a href="https://www.php.net/manual/fr/function.exit.php" target="_blank">exit</a>
				<b>met immédiatement fin au script PHP courant</b> et provoque l'envoi de
				la page telle qu'elle est au navigateur. <a
					href="https://www.php.net/manual/fr/function.exit.php" target="_blank">exit</a>
				n'est ni une instruction ni une fonction, mais une
				&quot;construction du langage&quot;.
			</p>
			<p class="fp-puce">
				<a href="https://www.php.net/manual/fr/function.exit.php" target="_blank">exit</a>
				peut être employée telle que (ie sans parenthèse et sans paramètre), ou avec un paramètre qui
				peut être une chaîne de caractères ou un entier :
			</p>
			<ul class="fp-ul-puce">
				<li>si le paramètre transmis à 
				<a href="https://www.php.net/manual/fr/function.exit.php" target="_blank">exit</a> est une chaîne,
				elle sera transmise au navigateur qui l'affichera;
				</li>
				<li>si le paramètre transmis à 
				<a href="https://www.php.net/manual/fr/function.exit.php" target="_blank">exit</a> est un entier,
				cette valeur constituera le statut de sortie du script et elle ne sera pas affichée. 
				Le statut de sortie peut être dans l'intervalle 0-255, le statut de sortie 255 est réservé par PHP et ne doit pas être utilisé. 
				Le statut 0 est utilisé pour terminer le programme avec succès. 
				</li>
			</ul>
			<p class="fp-remarque">
				<span class="fp-code">die</span> est un alias de <a
					href="https://www.php.net/manual/fr/function.exit.php" target="_blank">exit</a>
				et peut être utilisé à sa place avec les même règles.
			</p>

			<form action="" method="post" class="TEST-form">
				<div class="TEST-titre">
					<strong>Exemple</strong> : fin de script
				</div>
				<textarea name="txtCode" class="TEST-textarea">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr&quot;&gt;
&lt;head&gt;&lt;title&gt;Fin de script&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
Cette ligne sera affichée car située avant exit
&lt;?php
echo '&lt;p&gt;Traitement PHP ....&lt;/p&gt;';
$s = date('s');
echo $s, '&lt;hr&gt;';

// une erreur se produit, arrêt du script
if ($s % 2 == 0){
	exit('Erreur dans le script. Fin anormale du traitement');
}
exit(1);
?&gt;
Cette ligne ne sera pas affichée car située après exit
&lt;/body&gt;
&lt;/html&gt;</textarea>
			</form>

		</section>

		<h3>Niveaux d'erreur</h3>
		<section>

			<p class="fp-puce">Quand une erreur se produit dans un script PHP
				celui-ci ne sera pas forcément arrêté. Si le niveau de l'erreur
				n'est pas défini comme fatal, un message d'erreur sera simplement
				émis par PHP. Suivant la configuration de PHP, les messages d'erreur
				sont envoyés à la sortie courante (ie affiché dans la page) ou
				stockés dans un fichier. Si l'erreur est une erreur fatale,
				l'exécution du script s'arrête.</p>


			<p class="fp-bottom0 fp-puce">Il y a 3 niveaux d'erreur dans PHP
				:</p>
			<ul class="fp-ul-puce">
				<li>une erreur <span class="fp-code">notice</span> est une
					erreur sans gravité pour le script, par exemple utiliser une
					variable qui n'a pas été définie. PHP utilisera ses mécanismes
					internes pour &quot;corriger&quot; l'erreur. Le script
					fonctionnera, mais les résultats ne seront peut être pas ceux
					attendus.
				</li>
				<li>une erreur <span class="fp-code">warning</span> n'arrête
					pas le script. C'est le cas par exemple d'une fonction appelée avec
					des mauvais arguments. Un message sera affiché.
				</li>
				<li>une erreur <span class="fp-code">fatale</span> est une
					erreur qui arrête le script. Le plus souvent ce sont des <span
					class="fp-code">parse error</span> : le code est syntaxiquement
					incorrect.
			</ul>
			<p class="fp-puce">
				Par défaut, toutes les erreurs sauf <span class="fp-code">notice</span>,
				sont capturées et un message est affiché.
			</p>
			<p class="fp-puce">
				La fonction <a
					href="https://www.php.net/manual/fr/function.error-reporting.php" target="_blank">error_reporting()</a>
				permet de définir, pour un script, les erreurs qui seront capturées
				et pour lesquelles un message sera affiché.
			</p>

			<p class="fp-bottom0">La fonction accepte comme argument une ou
				plusieurs constantes :</p>
			<ul class="fp-ul-puce">
				<li><span class="fp-code">E_ERROR</span> : erreurs d'exécution
					graves provoquant un arrêt du script</li>
				<li><span class="fp-code">E_WARNING</span> : erreurs
					d'exécution sans arrêt du script</li>
				<li><span class="fp-code">E_NOTICE</span> : erreurs d'exécution
					faibles, comparables à des remarques</li>
				<li><span class="fp-code">E_CORE_ERROR</span> : erreurs
					internes graves de PHP</li>
				<li><span class="fp-code">E_CORE_WARNING</span> : erreurs
					internes de PHP sans arrêt du script</li>
				<li><span class="fp-code">E_COMPILE_ERROR</span> : erreurs
					internes de compilation du Zend Engine</li>
				<li><span class="fp-code">E_COMPILE_WARNING</span> : erreurs
					internes warning de compilation du Zend Engine</li>
				<li><span class="fp-code">E_USER_ERROR</span> : cf E_ERROR,
					mais déclenchée par le développeur dans le code avec <a
					href="https://www.php.net/manual/fr/function.trigger-error.php" target="_blank">trigger_error</a></li>
				<li><span class="fp-code">E_USER_WARNING</span> : cf E_WARNING,
					mais déclenchée par le développeur dans le code avec <a
					href="https://www.php.net/manual/fr/function.trigger-error.php" target="_blank">trigger_error</a></li>
				<li><span class="fp-code">E_USER_NOTICE</span> : cf E_NOTICE,
					mais déclenchée par le développeur dans le code avec <a
					href="https://www.php.net/manual/fr/function.trigger-error.php" target="_blank">trigger_error</a></li>
				<li><span class="fp-code">E_STRICT</span> : gestion des
					différences entre les versions de PHP</li>
				<li><span class="fp-code">E_RECOVERABLE_ERROR</span> : cf
					E_ERROR si elles ne sont pas gérées par le script</li>
				<li><span class="fp-code">E_DEPRECATED</span> : erreurs dûes à
					des instructions dépréciées de PHP (supprimées dans les versions
					futures)</li>
				<li><span class="fp-code">E_USER_DEPRECATED</span> : cf
					E_DEPRECATED, mais déclenchée par le développeur dans le code avec
					<a
					href="https://www.php.net/manual/fr/function.trigger-error.php" target="_blank">trigger_error</a></li>
				<li><span class="fp-code">E_ALL</span> : Toutes les erreurs</li>
			</ul>

			<p>Par exemple pour afficher toutes les erreurs d'exécution on
				appellera la fonction de la façon suivante en utilisant l'opérateur
				de bit | :</p>
			<pre>
error_reporting(E_ERROR | E_WARNING | E_PARSE | E_NOTICE);</pre>
			<p>Pour afficher toutes les erreurs :</p>
			<pre>
error_reporting(E_ALL);</pre>

			<p>Dans la phase de développement, le recours à la dernière
				instruction est utile, car il permet en particulier de déceler
				l'utilisation de variables non définies, source d'erreurs parfois
				difficiles à déceler.</p>
			<p>
				Pour supprimer tous les messages d'erreur (excépté les parse error
				qu'il n'est pas possible de supprimer), utilisez :<br> <span
					class="fp-code">error_reporting(0);</span>
			</p>
			<p class="fp-puce">L'utilisation de l'opérateur @ (arobase) placé
				devant une expression, ou une fonction qui renvoie une expression,
				supprime l'affichage de message en cas d'erreur dans l'instruction.</p>

			<form action="" method="post" class="TEST-form">
				<div class="TEST-titre">
					<strong>Exemple</strong> : utilisation de @
				</div>
				<textarea name="txtCode" class="TEST-textarea">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr&quot;&gt;
&lt;head&gt;&lt;title&gt;Utilisation de @&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;?php
echo 'Division par 0 avec message d\'erreur';

$resultat = 10 / 0;

echo '&lt;hr&gt;Division par 0 sans message d\'erreur';

$resultat = @(10 / 0);

?&gt;

&lt;/body&gt;
&lt;/html&gt;</textarea>
			</form>


		</section>

		<h3 id="Hb">Gestionnaire d'erreurs</h3>
		<section>
			<p class="fp-puce">
				Nous pouvons définir notre propre gestionnaire d'erreurs avec la
				fonction <a
					href="https://www.php.net/manual/fr/function.set-error-handler.php" target="_blank">set_error_handler()</a>.
				Cette fonction nécessite comme argument le nom de notre fonction
				personnalisée de gestion d'erreurs. Par exemple :<br> <span
					class="fp-code">set_error_handler('gererErreurs');</span>
			</p>
			<p class="fp-puce fp-bottom0">
				La fonction <span class="fp-code">gererErreurs()</span> recevra 5
				paramètres, passés <b>automatiquement</b> par PHP :
			</p>
			<ul class="fp-ul-puce">
				<li>code d'erreur</li>
				<li>message d'erreur</li>
				<li>nom du fichier où se produit l'erreur</li>
				<li>numéro de ligne de l'erreur</li>
				<li>copie de la table des symboles en cours.</li>
			</ul>

			<p class="fp-remarque">
				Pour remettre en place le gestionnaire d'erreurs initial, il faut
				utiliser la fonction <a
					href="https://www.php.net/manual/fr/function.restore-error-handler.php" target="_blank">restore_error_handler()</a>.
			</p>

			<form action="" method="post" class="TEST-form">
				<div class="TEST-titre">
					<strong>Exemple</strong> : gestionnaire d'erreurs
				</div>
				<textarea name="txtCode" class="TEST-textarea">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr&quot;&gt;
&lt;head&gt;&lt;title&gt;Gestionnaire d'erreurs&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;?php
error_reporting(E_ALL);  // aucune erreur acceptée
set_error_handler('gererErreurs');

echo '&lt;p&gt;Division par 0 avec message d\'erreur';

$resultat = 10 / 0;

//------------------------------------------------------
function gererErreurs($num, $msg, $fichier, $lig, $symb) {
  echo '&lt;p&gt;&lt;font color=&quot;red&quot;&gt;Une erreur s\'est produite : ',
       '&lt;br&gt;Numéro : ', $num,
       '&lt;br&gt;Message : ', $msg,
       '&lt;br&gt;Fichier : ', $fichier,
       '&lt;br&gt;Ligne : ', $lig;
  echo '&lt;pre&gt;Table des symboles : ';
  print_r($symb);
  exit;  // fin du script
}
?&gt;

&lt;/body&gt;
&lt;/html&gt;</textarea>
			</form>

			<p>
				Notre fonction <span class="fp-code">gererErreurs()</span> affiche
				toutes les informations qu'il est possible de récupérer sur une
				erreur. Vous pouvez remarquer que l'affichage de la table des
				symboles, n'est pas ici d'une grande utilité car le script ne
				manipule par beaucoup d'éléments. Vous remarquerez aussi que le nom
				du fichier dans lequel se produit l'erreur est un nom complet,
				donnant des informations sur les répertoires. Ces informations
				peuvent être utilisées à des fins de piratage et ne devraient pas
				être affichées. Nous allons donc constituer un message d'erreur plus
				sybillin.
			</p>

			<form action="" method="post" class="TEST-form">
				<div class="TEST-titre">
					<strong>Exemple</strong> : gestionnaire d'erreurs
				</div>
				<textarea name="txtCode" class="TEST-textarea">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr&quot;&gt;
&lt;head&gt;&lt;title&gt;Gestionnaire d'erreurs&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;?php
error_reporting(E_ALL);  // aucune erreur acceptée
set_error_handler('gererErreurs');

echo '&lt;p&gt;Division par 0 avec message d\'erreur';

$resultat = 10 / 0;

//------------------------------------------------------
function gererErreurs($num, $msg, $fichier, $lig, $symb) {
  echo '&lt;p&gt;&lt;font color=&quot;red&quot;&gt;L\'erreur ',$num,
       ' (', $msg, ') s\'est produite dans ',
       basename($fichier),
       ' à la ligne ', $lig;
  exit;  // fin du script
}
?&gt;

&lt;/body&gt;
&lt;/html&gt;</textarea>
			</form>
		</section>

		<h3>Redirection des messages d'erreur</h3>
		<section>

			<p class="fp-puce">Par défaut les messages d'erreurs sont dirigés
				vers la sortie courante : la page et donc le navigateur.</p>
			<p class="fp-puce">
				La fonction <a
					href="https://www.php.net/manual/fr/function.error-log.php" target="_blank">error_log()</a>
				permet de choisir une autre destination pour les messages d'erreurs,
				et d'en garder une trace. Elle accepte trois arguments : le message
				d'erreur, la destination du message, et optionnellement une adresse
				de destination :<br> <span class="fp-code">error_log(message,
					destination [,adresse]);</span>
			</p>
			<ul class="fp-ul-puce">
				<li>Si <span class="fp-code">destination</span> vaut 0, le
					message est envoyé dans le fichier d'erreur de PHP, défini dans la
					configuration de PHP avec l'option <span class="fp-code">error_log</span>.
				</li>
				<li>Si <span class="fp-code">destination</span> vaut 1, le
					message est envoyé à l'adresse e-mail donnée par l'argument <span
					class="fp-code">adresse</span>. Il faut que votre serveur dispose
					d'un serveur de mail pour réaliser correctement l'envoi.
				</li>
				<li>Si <span class="fp-code">destination</span> vaut 3, le
					message est ajouté à la fin du fichier dont le nom est donné par
					l'argument <span class="fp-code">adresse</span>. Le nom de fichier
					est un nom complet.
				</li>
			</ul>
			<p>L'exemple suivant montre la redirection des messages d'erreur
				dans un fichier appelé erreurs.txt</p>

			<form action="" method="post" class="TEST-form">
				<div class="TEST-titre">
					<strong>Exemple</strong> : gestionnaire d'erreurs
				</div>
				<textarea name="txtCode" class="TEST-textarea">&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;fr&quot;&gt;
&lt;head&gt;&lt;title&gt;Gestionnaire d'erreurs&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;?php
error_reporting(E_ALL);  // toutes les erreurs sont capturées

set_error_handler('gererErreurs');

echo '&lt;hr&gt;Division par 0';
$resultat = 10 / 0;

function gererErreurs($num, $msg, $fichier, $lig, $symb) {
	// Message affiché dans la page
	echo '&lt;p&gt;Une erreur s\'est produite ...';

	// message stocké
	$buffer = date('d/m/Y H:i:s')
			. " : erreur $num ($msg)"
			. " dans $fichier, ligne $lig\n";

	error_log($buffer, 3, 'erreurs.txt');
	exit;	// fin du script
}
?&gt;
&lt;/body&gt;
&lt;/html&gt;</textarea>
			</form>

			<p>
				Après avoir exécuté le script une (ou plusieurs fois), vous devez
				avoir dans votre dossier de travail le fichier "erreurs.txt"
				contenant les messages d'erreurs envoyés. <br> <a
					onclick="top.FP.Voir.showPLUS('exemple/gestionrepert.php')">Contenu
					de votre dossier de travail</a>
			</p>
			<p class="fp-remarque">Le dossier de travail contient déjà des
				sous-répertoires et fichiers de types divers qui sont préparés pour
				être utilisé tout au long de ce tutoriel</p>

			<!-- 
		<p>
			Cliquez plusieurs fois <a onclick="top.FP.Voir.testCode(0, '../exemple/gestion_erreurs.php')">sur
				ce lien</a> pour exécuter le script, puis examinez le résultat dans <a onclick="top.FP.Voir.showPHP('../exemple/gestionrepert.php')">votre
				dossier de travail</a>.
		</p>
		-->
		</section>

	</div>
	<footer></footer>
</body>
</html>